@page "/"
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using TicketTracker.Ui.Services
@using TicketTracker.Ui.Models
@using TicketTracker.Ui.Shared
@inject ITicketService TicketService
@inject ISnackbar Snackbar

<PageTitle>Report Issue</PageTitle>

<AuthorizeView>
    <NotAuthorized>
        <RedirectToLogin />
    </NotAuthorized>
    <Authorized>
        <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-8">
            <MudCard Elevation="25">
                <MudCardHeader>
                    <MudText Typo="Typo.h5">Report Issue</MudText>
                </MudCardHeader>
                <MudCardContent>
					<EditForm Model="model" OnValidSubmit="OnSubmitAsync" Context="formContext">
						<DataAnnotationsValidator />
						<MudTextField 
							@bind-Value="model.Title" 
							Label="Title" 
							Required="true" 
							RequiredError="Title is required" 
							MaxLength="200" 
						/>
						<MudTextField 
							@bind-Value="model.Description" 
							Label="Description" 
							Lines="5" 
							Placeholder="Describe the issue..."
							Required="true" 
							RequiredError="Description is required" 
							MaxLength="2000" 
							Class="mt-4"
						/>
						<MudStack Class="mt-4" Row="true" Spacing="2">
							<MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@isSubmitting" ButtonType="ButtonType.Submit">
								@(isSubmitting ? "Submitting..." : "Submit")
							</MudButton>
							<MudButton Variant="Variant.Text" Color="Color.Default" Disabled="@isSubmitting" OnClick="ResetForm">Reset</MudButton>
						</MudStack>
						<ValidationSummary />
					</EditForm>
				</MudCardContent>
			</MudCard>
		</MudContainer>
	</Authorized>
</AuthorizeView>

@code {
	private TicketCreateRequest model = new TicketCreateRequest();
	private bool isSubmitting = false;

	private async Task OnSubmitAsync()
	{
		if (isSubmitting) return;
		
		isSubmitting = true;
		
		var ok = await TicketService.CreateAsync(model);
		
		isSubmitting = false;

		if (ok)
		{
			Snackbar.Add("Ticket submitted successfully.", Severity.Success);
			StateHasChanged();
			ResetForm();
		}
		else
		{
			Snackbar.Add("Failed to submit ticket. Please try again.", Severity.Error);
		}
	}

	private void ResetForm()
	{
		model = new TicketCreateRequest();
	}
}